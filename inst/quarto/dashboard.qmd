---
title: "Анализ публикаций arXiv"
format: html
project:
  execute-dir: project
execute:
  echo: false
  warning: false
  message: false
---

```{r}
library(here)

old_wd <- getwd()

setwd(here())

library(tidyverse)
library(plotly)
library(lubridate)
library(tidytext)
library(igraph)

source(here("R", "classify_data.R"))
source(here("R", "get_arxiv_papers.R"))
source(here("R", "load_publications.R"))
source(here("R", "raw_data.R"))
source(here("R", "save_publications.R"))
source(here("R", "db.R"))
source(here::here("R", "text_utils.R"))

etl(cmax_results = 100)

final_data <- load_publications() %>%
  mutate(
    published_month = floor_date(published_date, "day"),
    published_weekday = wday(published_date, label = TRUE, abbr = TRUE)
  )

authors_long <- final_data %>%
  select(paper_id, authors) %>%
  mutate(authors = str_split(authors, ",\\s*")) %>%
  unnest(authors) %>%
  mutate(authors = str_trim(authors))

pubs_by_month <- final_data %>%
  count(published_month) %>%
  arrange(published_month)

top_authors <- authors_long %>%
  count(authors, sort = TRUE) %>%
  head(10)

tag_counts <- final_data %>%
  count(tag, sort = TRUE)

pubs_by_weekday <- final_data %>%
  count(published_weekday) %>%
  mutate(published_weekday = factor(published_weekday,
                                    levels = c("Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс")))

author_counts <- final_data %>%
  filter(!is.na(authors)) %>%
  mutate(n_authors = str_count(authors, ",") + 1)

```

## Кол-во публикаций по дням

```{r publ-by-day, echo=FALSE, message=FALSE, warning=FALSE}
plot_ly(
  pubs_by_month,
  x = ~published_month,
  y = ~n,
  type = "scatter",
  mode = "lines+markers",
  line = list(color = "#9467bd", width = 2),
  marker = list(size = 6, color = "#9467bd")
) %>%
  layout(
    xaxis = list(title = "Месяц"),
    yaxis = list(title = "Количество публикаций")
  )
```

## Авторы с наибольшим кол-вом публикаций

```{r authors-populars, echo=FALSE, message=FALSE, warning=FALSE}
plot_ly(top_authors, x = ~reorder(authors, n), y = ~n, type = 'bar',
        marker = list(color = '#2ca02c')) %>%
  layout(xaxis = list(tickangle = -45),
         yaxis = list(title = "Число публикаций"))
```

## Процентное соотношение публикаций с метками

```{r tags-percentage, echo=FALSE, message=FALSE, warning=FALSE}
plot_ly(
  tag_counts,
  labels = ~tag,
  values = ~n,
  type = "pie",
  textinfo = "label+percent",
  textposition = "inside",
  marker = list(colors = RColorBrewer::brewer.pal(12, "Set3"))
) %>%
  layout(
    title = list(text = "Распределение публикаций по тематическим меткам", x = 0.5),
    showlegend = TRUE
  )
```

## Число публикаций по дням недели

```{r publications-by-day, echo=FALSE, message=FALSE, warning=FALSE}
plot_ly(pubs_by_weekday, x = ~published_weekday, y = ~n, type = 'bar',
        marker = list(color = '#9467bd')) %>%
  layout(xaxis = list(title = "День недели"),
         yaxis = list(title = "Количество"))

```

## Самые частые слова в аннотациях

```{r top-words-all, echo=FALSE, message=FALSE, warning=FALSE}
top30 <- get_top_words(final_data, n = 30)

plot_ly(
  top30,
  x = ~reorder(word, n),
  y = ~n,
  type = "bar",
  marker = list(color = "#2ca02c")
) %>%
  layout(
    xaxis = list(title = "", tickangle = -45),
    yaxis = list(title = "Частота")
  )
```

## Распределение числа авторов в публикациях

```{r amounts-of-authors, echo=FALSE, message=FALSE, warning=FALSE}
plot_ly(
  author_counts,
  x = ~n_authors,
  type = "histogram",
  marker = list(color = "#9467bd")
) %>%
  layout(
    xaxis = list(title = "Число авторов"),
    yaxis = list(title = "Число публикаций")
  )
```

## Топ-5 ключевых слов по темам

```{r}
topic_words <- get_top_words_by_tag(final_data, n = 5)

if (nrow(topic_words) == 0) {
  plot_ly() %>% 
    layout(title = "Недостаточно данных для визуализации")
} else {
  topic_words <- topic_words %>%
    arrange(tag, desc(n)) %>%
    mutate(word = reorder_within(word, n, tag))

  p <- ggplot(topic_words, aes(x = n, y = word, fill = tag)) +
    geom_col(show.legend = FALSE) +
    facet_wrap(~ tag, scales = "free_y", ncol = 4) + 
    scale_y_reordered() +
    labs(
      x = "Частота",
      y = "Ключевое слово"
    ) +
    theme_minimal() +
    theme(
      strip.text = element_text(face = "bold", size = 9),
      axis.text.y = element_text(size = 8),
      axis.text.x = element_text(size = 8),
      plot.title = element_text(hjust = 0.5, size = 12),
      panel.spacing = unit(0.3, "cm"),
      panel.background = element_rect(fill = "white", colour = "gray80")
    )

  ggplotly(p)
}
```
